#!/usr/bin/env bash
set -e
echo "âœï¸ pre-commit: auto-fix JSON"

FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.json$' || true)

[ -z "$FILES" ] && exit 0

for f in $FILES; do
  echo "  formatting $f"
  jq . "$f" > "$f.tmp"
  mv "$f.tmp" "$f"
  git add "$f"
done

echo "âœ… JSON formatted and re-staged"

echo "ğŸš¨ pre-commit: full validation (CI equivalent)"

# ---- nvm åˆæœŸåŒ–ï¼ˆé‡è¦ï¼‰ ----
export NVM_DIR="$HOME/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
else
  echo "âŒ nvm not found"
  exit 1
fi

nvm use 20 >/dev/null

# ---- å®Ÿè¡Œ ----
command -v npm >/dev/null || {
  echo "âŒ npm not found even after nvm init"
  exit 1
}

npm ci
npm run validate

